{{ ansible_managed | comment }}

# See unbound.conf(5) man page.
# https://www.unbound.net/documentation/unbound.conf.html
#
# Use this to include other text into the file.
# include: "otherfile.conf"

# The server clause sets the main parameters.
server:
    # use all CPUs
    num-threads: {{ threads.stdout }}
    # power of 2 close to num-threads (e.g. 1, 2, 4, 8, 16)
    msg-cache-slabs: {{ threads.stdout }}
    rrset-cache-slabs: {{ threads.stdout }}
    key-cache-slabs: {{ threads.stdout }}
    infra-cache-slabs: {{ threads.stdout }}
    # convert bytes to mebibytes: 1 mebibyte = 2^20 = 1024*1024 = 1048576 bytes
    msg-cache-size: {{ cache_memory.stdout | int // 2**20 }}m
    rrset-cache-size: {{ cache_memory.stdout | int // 2**20 * 2 }}m # rrset=msg*2
    key-cache-size: {{ cache_memory.stdout | int // 2**20 // 2 }}m

{% if unbound_tls is defined %}
    ssl-service-key: {{ unbound_tls.private_key }}
    ssl-service-pem: {{ unbound_tls.cert }}
    ssl-port: {{ unbound_tls.port }}
{% endif %}

{% if unbound_server is defined%}
    ###
    {%- for key, value in unbound_server.iteritems() -%}
    {%- set key = key|replace("_", "-") -%}
        {%- if value|string == "1" or value|string == "0" %}

    {{key}}: {{value}}
        {%- elif value == True %}

    {{key}}: yes
        {%- elif value == False %}

    {{key}}: no
        {%- elif value == none %}

    {{key}}: ""
        {%- elif value|string == "" %}

    {{key}}: {{ '""' }}
        {%- elif value is iterable and value is not string %}
            {%- for item in value %}

    {{key}}: {{item}}
            {%- endfor -%}
        {%- else %}

    {{key}}: {{value}}
        {%- endif -%}
    {%- endfor %}

    ###
{% endif %}

{% if opennic %}
    domain-insecure: "dns.opennic.glue"
{% for tld in tlds.stdout_lines if tld != '.' %}
    domain-insecure: "{{tld}}"
{% endfor -%}
{% endif %}

# Remote control config section.
remote-control:
    # Enable remote control with unbound-control(8) here.
    control-enable: yes
    control-interface: 127.0.0.1
    # control-port: 953
    server-key-file: "{{_unbound.conf_dir}}/unbound_server.key"
    server-cert-file: "{{_unbound.conf_dir}}/unbound_server.pem"
    control-key-file: "{{_unbound.conf_dir}}/unbound_control.key"
    control-cert-file: "{{_unbound.conf_dir}}/unbound_control.pem"

# Stub zones.
{% if opennic %}
stub-zone:
    name: "dns.opennic.glue"
    stub-addr: "127.0.0.1@{{nsd_port}}"

{% for tld in tlds.stdout_lines if tld != '.' %}
stub-zone:
    name: "{{tld}}"
    stub-addr: "127.0.0.1@{{nsd_port}}"

{% endfor -%}
{% endif %}

# Forward zones
# forward-zone:
#     name: "."
#     forward-addr: 8.8.4.4        # Google
#     forward-addr: 8.8.8.8        # Google
#     forward-addr: 208.67.222.220 # OpenDNS
#     forward-addr: 208.67.222.222 # OpenDNS
#     forward-addr: 50.116.23.211  # OpenNIC
#     forward-addr: 216.146.35.35  # Dyn Public
#     forward-addr: 216.146.36.36  # Dyn Public
#     forward-addr: 64.6.64.6      # Verisign
#     forward-addr: 64.6.65.6      # Verisign
#     forward-addr: 37.235.1.174   # FreeDNS
#     forward-addr: 37.235.1.177   # FreeDNS
#     forward-addr: 84.200.69.80   # DNS Watch
#     forward-addr: 84.200.70.40   # DNS Watch
#     forward-addr: 74.82.42.42    # Hurricane Electric
#     forward-addr: 91.239.100.100 # censurfridns.dk
#     forward-addr: 109.69.8.51    # puntCAT
