---
- name: read platform variables
  include_vars:
    file: "{{ ansible_os_family }}.yml"
  tags: [always]

- name: Install unbound
  package:
    name: unbound
    state: present
  # when: ansible_os_family != 'FreeBSD'

# - name: Install unbound from port
#   portinstall:
#     name: unbound
#     state: present
#   when: ansible_os_family == 'FreeBSD'

# https://github.com/jedisct1/dnscrypt-server-docker/blob/master/unbound.sh
- name: Set cache_memory variable from shell command
  shell: "{{_unbound.memory_script}}"
  args:
    executable: bash
  register: cache_memory
  check_mode: no

- debug: msg="{{ cache_memory.stdout }}"

- name: Setup or update of the root trust anchor for DNSSEC validation
  command: unbound-anchor -a "{{unbound_server.auto_trust_anchor_file}}"
  register: unbound_anchor_result
  changed_when: "unbound_anchor_result.rc == 1"
  failed_when: false # ignore failure silently FixMe
  # Return value 1 = updated
  # Return value 0 = no update was necessary, updated with RFC5011tracking, or an error occurred

- name: Check if unbound_control.pem file exists
  stat:
    path: "{{_unbound.conf_dir}}/unbound_control.pem"
  register: p

- name: Setup unbound-control
  when: not p.stat.exists
  command: unbound-control-setup
  notify: Restart unbound with cache

# https://www.internic.net/domain/named.cache
# Update root.hints every six months or so
- name: Get root-hints cache
  get_url:
    url: https://www.internic.net/domain/named.root
    dest: "{{unbound_server.root_hints}}"

- name: Set threads variable from shell command
  shell: "if [ $(nproc) -gt 1 ]; then echo $(($(nproc)-1)); else echo 1; fi"
  args:
    executable: bash
  register: threads
  check_mode: no

- debug: msg="{{ threads.stdout }}"


- name: Copy unbound configuration
  template:
    src: unbound.conf
    dest: /etc/unbound/unbound.conf
  notify: Restart unbound with cache

- name: Check unbound configuration
  command: unbound-checkconf
  check_mode: no

# SELinux
- name: Configure ports for SELinux (install policycoreutils-python)
  package:
    name: policycoreutils-python # for semanage
    state: present
  when: ansible_selinux

- name: Configure ports for SELinux (mark udp port for dns)
  seport:
    ports: "{{dns_recursor_port}}"
    proto: udp
    setype: dns_port_t
    state: present
  when: ansible_selinux

- name: Configure ports for SELinux (mark tcp port for dns)
  seport:
    ports: "{{dns_recursor_port}}"
    proto: tcp
    setype: dns_port_t
    state: present
  when: ansible_selinux

- name: Ensure unbound is running
  service:
    name: unbound
    state: started
    enabled: true
    pattern: unbound
