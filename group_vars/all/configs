---
ansible_python_interpreter: "/usr/bin/env python"
custom_packages:
  - htop

# [DEBIAN auto updates] https://github.com/jnv/ansible-role-unattended-upgrades
# unattended_mail: your@email.com # e-mail address to send information about upgrades or problems with unattended upgrades
unattended_origins_patterns: # https://github.com/jnv/ansible-role-unattended-upgrades#patterns-examples
  - 'origin=Ubuntu,archive=${distro_codename}-security'
  - 'o=Ubuntu,a=${distro_codename}-proposed-updates'
  - 'o=Ubuntu,a=${distro_codename}-updates'
  - 'o=Ubuntu,a=${distro_codename}'
unattended_install_on_shutdown: false
unattended_automatic_reboot: false
unattended_automatic_reboot_time: false
unattended_ignore_apps_require_restart: false
unattended_remove_unused_dependencies: false

# [REDHAT auto updates] https://github.com/jeffwidman/ansible-yum-cron
# email_to: your@email.com
emit_via: stdio
system_name: dns.seby.io
hourly_update_level: security
hourly_update_message: yes
hourly_download_updates: yes
hourly_apply_updates: yes
hourly_random_sleep: 15
daily_update_level: default
daily_update_message: yes
daily_download_updates: no
daily_apply_updates: no
daily_random_sleep: 180
yum_cron_clean_what: packages # keep metadata
yum_cron_clean_when: weekly
# hourly_base_options: ["exclude=*"]
# daily_base_options: "{{ hourly_base_options }}"

# [OpenNIC / nsd]
opennic: true
nsd_chroot_enable: true
# nsd_chroot_dir: /opt/nsd
nsd_compile_flags: "--enable-root-server"
nsd_ip_addresses: ["127.0.0.1"]
nsd_reuseport: "yes"
nsd_port: 552
nsd_hide_version: "yes"
nsd_round_robin: "yes"
nsd_remote_control: "yes"
nsd_minimal_responses: "no"
nsd_do_ip6: "yes"

# [unbound] https://www.unbound.net/
# https://www.unbound.net/documentation/unbound.conf.html
# https://www.unbound.net/documentation/howto_optimise.html
unbound_compile: true
# unbound_compile_version: 1.6.8
# unbound_compile_sha256: e3b428e33f56a45417107448418865fe08d58e0e7fea199b855515f60884dd49
# unbound_compile_config: "--enable-dnscrypt --enable-gost --enable-ed25519 --with-libevent --with-username={{unbound.server.username|default(unbound)}} --with-run-dir={{unbound.server.directory}} --with-conf-file={{unbound.server.directory}}/unbound.conf"
unbound_munin: true
unbound_optimise: true
unbound_optimise_memory: 30
unbound_tls_domain: dns.seby.io
unbound_tls_cert_provider: acme
unbound_tls_acme_auto_upgrade: 1
unbound_tls_acme_mode: dns dns_cf
unbound_tls_acme_staging: false
unbound_tls_acme_force: false
# unbound_tls_acme_ecc: true
unbound_tls_acme_custom: --dnssleep 10
opennic_address: "{{nsd_ip_addresses|first}}@{{nsd_port}}"
unbound:
  server:
    ## logs
    verbosity: 0 # no verbosity, only errors
    use_syslog: yes
    log_time_ascii: yes
    val_log_level: 0 # 1 = log dnssec validation errors for investigating problems 2 = (domain, dns server ip and reason)
    # statistics_interval: 86400 # once a day print latency statistics
    # pidfile: unbound.pid
    statistics_interval: 0 # for munin graphs
    extended_statistics: yes # for munin graphs
    statistics_cumulative: no # for munin graphs
    ## Server
    interface_automatic: yes
    interface: [127.0.0.1, '::1', 0.0.0.0@853, '::0@853']  # overwritten in host_vars to add {{ansible_vtnet1.ipv4[0].address}}
    port: 53
    ssl_service_key: private.key
    ssl_service_pem: certificate.pem
    ssl_port: 853
    root_hints: root.hints
    # udp_upstream_without_downstream: yes
    access_control: [0.0.0.0/0 allow, '::/0 allow']
    ## Privacy
    qname_minimisation: yes
    # use_caps_for_id: yes # some older servers don't handle this properly
    # caps-whitelist:

    # Don't send local queries out further, send NXDOMAIN instead, protect bad configured clients
    # valid TLDs https://www.iana.org/domains/root/db
    # popular undelegated TLDs hitting L-root http://stats.dns.icann.org/hedgehog/
    # ^ http://mm.icann.org/pipermail/gnso-newgtld-wg-wt4/2017-May/000070.html
    local_zone:
      - example. static # reserved
      # - invalid. static # reserved
      - local. static # reserved
      # - localhost. static # reserved
      # - onion. static # Tor Project
      # - test. static # reserved
      - i2p. static # I2P Anonymous Network
      # - glue. static # OpenNIC - disable if you support OpenNIC
      - home. static
      - zghjccbob3n0. static
      - dhcp. static
      - lan. static
      - localdomain. static
      - ip. static
      - internal. static
      - openstacklocal. static
      - dlink. static
      - gw==. static
      - gateway. static
      - corp. static
      - workgroup. static
      - belkin. static
      - davolink. static
      - z. static
      - domain. static
      - virtualmin. static
    ## Performance
    so_reuseport: yes
    serve_expired: yes
    prefetch: yes
    prefetch_key: yes
    rrset_roundrobin: yes # possible load distribution for servers
    num_queries_per_thread: 2048
    outgoing_range: 4096 # (num-queries-per-thread * 2) # allowed num of file descriptors
    # outgoing_port_avoid: 5546 # fix unable to bind to port error (centOS)
    incoming_num_tcp: 200
    outgoing-num-tcp: 20
    # Sydney, AU to New York, USA (http://nj-us-ping.vultr.com/) avg ping 224ms
    # Sydney, AU to Paris, FR (http://par-fr-ping.vultr.com) avg ping 309ms
    # Sydney, AU to Amsterdam, NL (http://ams-nl-ping.vultr.com) avg ping 318ms
    # Sydney, AU to London, EN (http://lon-gb-ping.vultr.com) avg ping 301ms
    jostle_timeout: 325 # single shot udp packet ttl in ms
    # so_rcvbuf: 4m
    # so_sndbuf: 4m
    neg_cache_size: 25m
    cache_min_ttl: 60 # 86400=1day 43200=12h 3600=1h 1800=30m 1200=20m 900=15m 600=10m 300=5m=standard, 0 (default)
    cache_max_ttl: 86400 # 14400=4h 86400=1day (default)
    # cache_max_negative_ttl: 3600 # 1h (default)
    # val-bogus-ttl: 120 # 60 (default)
    infra_host_ttl: 3600 # 1h, 900=15min (default) http://www.unbound.net/documentation/info_timeout.html
    # infra_cache_numhosts: 50000 # already set with unbound_optimise=true
    ## Security
    hide_identity: yes
    hide_version: yes
    hide-trustanchor: yes
    minimal_responses: yes # reduce reflected DoS effects
    # harden_short_bufsize: yes
    # harden_large_queries: yes
    harden_below_nxdomain: yes
    # harden_algo_downgrade: yes
    unwanted_reply_threshold: 10000000
    ## https://tools.ietf.org/html/rfc5735#section-3
    ## https://www.iana.org/help/abuse-answers
    private_address:
      - 10.0.0.0/8 # private networks (RFC 1918)
      - 172.16.0.0/12
      - 192.168.0.0/16
      - 169.254.0.0/16 # link-local network (RFC 3927)
      - fd00::/8
      - fe80::/10
    do_not_query_localhost: no # allow to contact nsd on same host
    do_not_query_address:
      # - 127.0.0.0/8 # Loopback
      # - ::1
      - 10.0.0.0/8 # private networks (RFC 1918):
      - 172.16.0.0/12
      - 192.168.0.0/16
    ratelimit: 50 # prevent being part of a DDoS to authoritative
    # ratelimit-for-domain: example.com # exact match
    # ratelimit-below-domain: example.com 3
    ip_ratelimit: 25 # prevent client DoS and other abuse
    # ip_ratelimit_size: 4m
    ###
    ## Vultr is filtering domains that seriously impacts the performance of neighboring instances.
    ## Vultr blocks this domain and less than 10 others around crypto currency mining and automated traffic bots.
  forward_zone:
    forward_addr: 9.9.9.9@853 # quad9.net
    forward_ssl_upstream: yes
    name: minexmr.com
  # local_zone: "tracker.publicbt.com" static # (blackhole) Nameserver (lv3ns2.ffdns.net) doesn't respond to publicbt.com: http://dnsviz.net/d/tracker.publicbt.com/dnssec/
  # local_zone: "tracker.flashtorrents.org" static # (blackhole) Nameserver (nl319.edns1.com) doesn't respond to flashtorrents.org: http://dnsviz.net/d/tracker.flashtorrents.org/dnssec/
  remote_control:
    control_enable: true
    control_interface: 127.0.0.1

# I'm using a private network/interface
# munin_bind: "0.0.0.0"

# [dnscrypt-wrapper] https://github.com/cofyc/dnscrypt-wrapper
dnscrypt_wrapper: true
dnscrypt_wrapper_git_version: v0.3
# dnscrypt_wrapper_git_version: master

# [DNSCrypt-autokey]
dnscrypt_provider_name: '2.dnscrypt-cert.dns.seby.io'
dnscrypt_chacha20: 0 # OpenBDS no chacha20 in tlslib by default
dnscrypt_validity_period: 1 # days
dnscrypt_mode: wrapper
dnscrypt_keydir:
dnscrypt_ports:
  - 443
  - 5353
  - 8080
dnscrypt_listen: 0.0.0.0

# DNS-over-HTTPS/2
doh: true

# https://dnsprivacy.org/wiki/display/DP/Building+HAProxy+so+that+it+can+use+TLSv1.3
# https://serverfault.com/questions/504308/by-what-criteria-do-you-tune-timeouts-in-ha-proxy-config
haproxy_config: |
  global
          ### netdata
          ## stats socket /var/run/haproxy.sock mode 660 level operator group netdata
          ## stats timeout 2m #Wait up to 2 minutes for input
          log 127.0.0.1   local0 debug
          # log /var/run/log local0 notice
          maxconn 1024
          # maxconn 2048
          # maxconn 4000
          chroot /var/haproxy
          uid 604
          gid 604
          # user haproxy
          # group haproxy
          daemon
          pidfile /var/run/haproxy.pid
          # ssl-default-bind-ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
          # ssl-default-bind-ciphers TLS13-AES-256-GCM-SHA384:TLS13-AES-128-GCM-SHA256:TLS13-CHACHA20-POLY1305-SHA256:EECDH+AESGCM:EECDH+CHACHA20
          # ssl-default-bind-options no-tls-tickets no-sslv3
          # ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11 no-tlsv12

  defaults
          log     global
          mode    http
          option  httplog
          option  dontlognull
          option  redispatch
          retries 3
          maxconn 2000
          # option http-server-close
          # option forwardfor
          ## option dontlog-normal
          ## balance roundrobin
          # timeout http-request 10s
          # timeout queue 10s
          timeout connect 5s
          timeout check 10s
          timeout client 20s
          timeout server 15s
          # timeout http-keep-alive 10s

  frontend http-in
          bind *:80
          mode http
          redirect location https://www.dns.seby.io code 301 if { hdr(host) -i dns.seby.io }
          redirect location https://www.dns.seby.io code 301 if { hdr(host) -i www.dns.seby.io }
          redirect location https://www.ntppool.org/en/ code 301

  frontend doh-in
          bind *:452
          bind *:453 ssl crt {{haproxy_path}}/bundle.pem alpn h2,http/1.1 # h2,http/1.1
          acl dns_url path_beg -i /dns-query
          use_backend doh-servers if dns_url
          redirect location https://www.dns.seby.io code 301 if !dns_url { hdr(host) -i dns.seby.io }
          redirect location https://www.dns.seby.io code 301 if { hdr(host) i www.dns.seby.io }
          redirect location https://www.ntppool.org/en/ code 301 if { hdr(host) -i ntppool.org }
          default_backend doh-servers

  backend doh-servers
          option forwardfor
          server doh-proxy 127.0.0.1:3000

  #listen dns-over-tls
  #    maxconn 10
  #    bind 0.0.0.0:853 tfo ssl crt {{haproxy_path}}/bundle.pem
  #    server unbound 127.0.0.1:53 # unbound
  #    #server unboundtls 127.0.0.1:854 ssl verify none # unbound tls
